<script setup lang="ts">
import { reactive, ref, watch } from 'vue';
import { type RouteRecordRaw, useRouter, useRoute } from 'vue-router';
import type { MenuProps, ItemType } from 'ant-design-vue';

import { routes } from '@/router';

function getMenuItem(_routes: RouteRecordRaw[]): ItemType[] {
  return _routes
    .filter(route => route.meta?.visible)
    .map(route => {
      return {
        key: route.name,
        icon: route.meta?.icon || null,
        label: route.meta?.label,
        type: route.meta?.type,
        children: route.children ? getMenuItem(route.children) : null
      } as ItemType
    })
}

const menuItem = getMenuItem(routes);

const items: ItemType[] = reactive(menuItem);

const route = useRoute();
const router = useRouter();

const selectedKeys = ref<string[]>([]);
const routeNameWatch = watch(() => route.name, (newName) => {
  if (selectedKeys.value.length > 0) {
    routeNameWatch();
  }

  selectedKeys.value = [ newName as string ];
}, {
  immediate: true
});

const openKeys = ref<string[]>(['sub1']);

const handleClick: MenuProps['onClick'] = e => {
  router.push({
    name: e.key as string
  });
}
</script>

<template>
  <div class="sider">
    <div class="sider-header">
      <svg class="sider-header-logo" viewBox="0 0 276.85 66.99">
        <defs>
          <linearGradient
            id="a"
            x1="192.35"
            x2="255.58"
            y1="-.85"
            y2="83.06"
            gradientUnits="userSpaceOnUse"
          >
            <stop offset=".05" stop-color="#6ca5e5" />
            <stop offset=".85" stop-color="#7d73ee" />
          </linearGradient>
        </defs>
        <path
          d="M276.6 60.45c-.18-.59-.52-1.17-.99-1.73l-8.5-10.91-1.88 2.35a7.939 7.939 0 0 0-.28 9.56l3.34 4.72c.66.82 1.31 1.36 1.97 1.68.64.3 1.3.45 1.94.45 1.37 0 2.55-.5 3.4-1.45.81-.9 1.24-2.01 1.24-3.21 0-.46-.08-.94-.24-1.47Zm-46.09-36.17c-.97-.49-1.79-.72-2.51-.72s-1.54.24-2.51.72c-.93.47-2.05 1.56-2.05 4.1v33.37c0 2.54 1.11 3.64 2.05 4.1.97.49 1.79.72 2.51.72s1.54-.24 2.51-.72c.93-.47 2.05-1.56 2.05-4.1V28.38c0-2.54-1.11-3.63-2.05-4.1Zm-18.84-15.6c-3.85-2.78-8.95-4.18-15.17-4.18h-12.78c-3.31 0-5.29 1.99-5.29 5.32v51.7c0 2.57 1.1 3.72 2.02 4.23 1.01.57 1.9.84 2.7.84s1.69-.27 2.7-.84c.92-.51 2.02-1.67 2.02-4.23V39.11h8.47c6.21 0 11.34-1.42 15.25-4.22 4.09-2.93 6.16-7.35 6.16-13.12s-2.05-10.17-6.08-13.08Zm-6.26 19.49c-2.09 1.56-5.25 2.35-9.39 2.35h-8.14V13.17h8.14c4.06 0 7.21.75 9.37 2.22 1.97 1.35 2.92 3.43 2.92 6.37s-.95 4.95-2.9 6.41Zm22.6-22.69c-1.43 0-2.74.53-3.88 1.57-1.19 1.07-1.81 2.51-1.81 4.16s.63 3.09 1.81 4.16c1.15 1.04 2.46 1.57 3.88 1.57s2.73-.53 3.88-1.57c1.19-1.07 1.81-2.51 1.81-4.16s-.63-3.09-1.81-4.16c-1.15-1.04-2.46-1.57-3.88-1.57Zm46.11 25.73c.58-.67.94-1.31 1.09-1.97.11-.49.17-.91.17-1.26 0-1.25-.46-2.36-1.33-3.19-.85-.8-1.93-1.23-3.14-1.23-.55 0-1.15.13-1.76.37-.7.28-1.36.81-2.01 1.63l-9.25 11.99-9.16-11.83c-.78-1.02-1.51-1.62-2.28-1.88-.59-.2-1.18-.3-1.74-.3-1.23 0-2.34.46-3.22 1.34-.88.88-1.34 2-1.34 3.24 0 1.01.4 2.04 1.22 3.11l10.78 13.16-12.06 14.54c-.49.57-.82 1.16-1 1.74a5.06 5.06 0 0 0-.24 1.47c0 1.26.46 2.36 1.33 3.19.84.8 1.9 1.23 3.06 1.23.55 0 1.15-.13 1.76-.37.7-.28 1.35-.8 1.91-1.52l10.89-13.55 5.68-6.98 10.66-12.96Z"
          fill="url(#a)"
        />
        <path
          d="M88.84 26c-3.33-1.89-7.17-2.85-11.42-2.85s-8.02.96-11.34 2.85c-3.33 1.9-5.98 4.53-7.87 7.82-1.89 3.29-2.84 7.07-2.84 11.25s.96 7.89 2.84 11.2c1.89 3.33 4.54 5.97 7.88 7.87 3.32 1.89 7.14 2.85 11.34 2.85s8.1-.96 11.42-2.85c3.33-1.9 5.98-4.55 7.88-7.87 1.88-3.32 2.84-7.08 2.84-11.2s-.96-7.96-2.84-11.25A20.809 20.809 0 0 0 88.86 26Zm-.32 26.02c-1.06 2.07-2.48 3.66-4.37 4.86-1.84 1.17-4.11 1.77-6.73 1.77s-4.81-.59-6.65-1.77c-1.89-1.2-3.31-2.79-4.37-4.86-1.06-2.08-1.59-4.42-1.59-6.95s.54-4.94 1.59-6.98c1.04-2.03 2.52-3.67 4.39-4.88 1.84-1.19 4.07-1.8 6.64-1.8s4.88.61 6.72 1.8c1.87 1.21 3.34 2.85 4.39 4.88 1.06 2.05 1.59 4.4 1.59 6.99s-.54 4.87-1.59 6.95ZM115.09.72c-.97-.48-1.79-.72-2.51-.72s-1.54.24-2.51.72c-.93.47-2.05 1.56-2.05 4.1v56.93c0 2.54 1.11 3.64 2.05 4.1.97.49 1.79.72 2.51.72s1.54-.24 2.51-.72c.93-.47 2.05-1.56 2.05-4.1V4.83c0-2.54-1.11-3.63-2.05-4.11Zm44 25.28c-3.33-1.89-7.17-2.85-11.42-2.85s-8.02.96-11.34 2.85c-3.34 1.9-5.98 4.53-7.87 7.82-1.89 3.29-2.84 7.07-2.84 11.25s.96 7.89 2.84 11.2c1.89 3.32 4.54 5.97 7.88 7.87 3.32 1.89 7.14 2.85 11.34 2.85s8.1-.96 11.42-2.85c3.34-1.9 5.98-4.55 7.88-7.87 1.89-3.32 2.84-7.08 2.84-11.2s-.96-7.96-2.84-11.25c-1.89-3.29-4.54-5.92-7.87-7.82Zm-.32 26.02c-1.06 2.07-2.48 3.66-4.37 4.86-1.84 1.17-4.11 1.77-6.74 1.77s-4.81-.59-6.65-1.77c-1.89-1.2-3.31-2.79-4.37-4.86-1.06-2.08-1.59-4.42-1.59-6.95s.53-4.94 1.59-6.99c1.04-2.02 2.52-3.67 4.39-4.88 1.84-1.19 4.07-1.8 6.64-1.8s4.88.61 6.72 1.8c1.87 1.21 3.34 2.85 4.39 4.88 1.06 2.05 1.59 4.4 1.59 6.99s-.54 4.87-1.59 6.95ZM46.72 9c0-2.66-1.12-3.81-2.07-4.3-1-.52-1.87-.77-2.65-.77s-1.65.25-2.66.78c-.94.49-2.06 1.64-2.06 4.3v12.34a6.8 6.8 0 0 0 6.8 6.8h2.65V9ZM9.44 29.61V9c0-2.66-1.12-3.81-2.07-4.3-1-.52-1.87-.77-2.65-.77s-1.65.25-2.66.78C1.12 5.2 0 6.35 0 9.01v52.52c0 2.56 1.1 3.72 2.02 4.23 1.01.57 1.9.84 2.7.84s1.69-.27 2.7-.84c.92-.51 2.02-1.67 2.02-4.23V38.62h18.78c5.01 0 9.06 4.06 9.06 9.06v13.84c0 2.57 1.1 3.72 2.02 4.23 1.01.57 1.9.84 2.7.84s1.69-.27 2.7-.84c.92-.51 2.02-1.67 2.02-4.23V48.63c0-10.5-8.51-19.02-19.02-19.02H9.44Z"
          fill="#fff"
        />
      </svg>
    </div>

    <a-menu
      class="sider-menu"
      v-model:openKeys="openKeys"
      v-model:selectedKeys="selectedKeys"
      mode="inline"
      theme="dark"
      :items="items"
      @click="handleClick"
    />
  </div>
</template>

<style lang="less" scoped>
.sider {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  .sider-header {
    padding: 12px;
    height: @headerHeight;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    .sider-header-logo {
      // height: 100%;
      height: 24px;
    }
  }

  .sider-menu {
    padding-top: @siderMenuVerticalPadding;
    padding-bottom: @siderMenuVerticalPadding;
    flex: auto;
    overflow: auto;
  }
}
</style>